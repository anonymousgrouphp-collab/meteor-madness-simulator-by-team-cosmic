<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteor Madness - Geopolitical Impact Simulator</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; cursor: crosshair; background-color: #1e3a8a; }
        .leaflet-container { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 350px; max-height: 400px; }
        .slider-thumb-orange::-webkit-slider-thumb { background-color: #f97316; }
        .slider-thumb-orange::-moz-range-thumb { background-color: #f97316; }
        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
        .prose h3 { color: #fb923c; margin-bottom: 0.5rem; font-size: 1.1em; }
        .prose ul { list-style-position: inside; padding-left: 0; }
        .prose li, .prose p { margin-bottom: 0.75rem; }
        .nasa-item:hover { background-color: #3f3f46; }
        button:focus, select:focus, input[type=range]:focus, input[type=checkbox]:focus {
            outline: 2px solid #fb923c;
            outline-offset: 2px;
        }
        .briefing-panel {
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .briefing-panel.visible {
            max-height: 500px;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div id="audio-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[1000]">
        <div class="text-center p-8">
            <h2 class="text-3xl font-bold mb-4 text-white">Enable Audio?</h2>
            <p class="text-gray-300 mb-6">This experience uses sound effects for better immersion.</p>
            <button id="enable-audio" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Yes, enable audio</button>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-6xl font-bold text-white tracking-tighter">Meteor Madness</h1>
            <p class="text-lg md:text-xl text-gray-400 mt-2">Geopolitical Impact Simulator</p>
        </header>

        <main>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="controls" class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700 space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Load Data</h3>
                        <button id="load-nasa-data" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" aria-label="Load real near-Earth object close approaches from NASA">Load Real Close Approaches (Next 7 Days)</button>
                        <div id="nasa-data-container" class="mt-4 max-h-40 overflow-y-auto hidden">
                            <ul id="nasa-data-list" class="text-sm space-y-1"></ul>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Impact Parameters</h3>
                        <div>
                            <label for="asteroid-size" class="block text-sm font-medium text-gray-300">Asteroid Diameter (meters)</label>
                            <input id="asteroid-size" type="range" min="10" max="1000" value="140" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb-orange" aria-label="Adjust asteroid diameter">
                            <span id="size-value" class="text-orange-400 font-mono text-center block mt-2">140 m</span>
                        </div>
                        <div class="mt-4">
                            <label for="asteroid-velocity" class="block text-sm font-medium text-gray-300">Impact Velocity (km/s)</label>
                            <input id="asteroid-velocity" type="range" min="10" max="70" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb-orange" aria-label="Adjust asteroid velocity">
                            <span id="velocity-value" class="text-orange-400 font-mono text-center block mt-2">20 km/s</span>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Impact Location</h3>
                         <div id="map-container" class="w-full h-48 rounded-lg bg-gray-700 z-0">
                            <div id="map"></div>
                         </div>
                         <p class="text-center text-sm text-gray-400 mt-2">Click map to set target. Current: <span id="location-name" class="font-bold text-orange-400">Ocean</span></p>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Mitigation Systems</h3>
                        <div>
                           <label for="mitigation-strategy" class="block text-sm font-medium text-gray-300">Select Strategy</label>
                           <select id="mitigation-strategy" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 mt-1" aria-label="Select a mitigation strategy">
                               <option value="none">None (No Action)</option>
                               <option value="kinetic_impactor">Kinetic Impactor</option>
                               <option value="gravity_tractor">Gravity Tractor</option>
                               <option value="laser_ablation">Laser Ablation</option>
                           </select>
                        </div>
                       <p id="mitigation-status" class="text-sm mt-2 text-gray-400">No mitigation strategy selected.</p>
                       <div id="mitigation-briefing-container" class="briefing-panel mt-4 bg-gray-900/50 p-4 rounded-lg prose text-gray-300 text-sm">
                           <h4 id="mitigation-title" class="text-orange-400 font-bold"></h4>
                           <p id="mitigation-description"></p>
                           <div id="mitigation-details"></div>
                       </div>
                    </div>
                </div>

                <div id="visuals-analysis" class="lg:col-span-2 space-y-8">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Trajectory & Impact Visualizer</h3>
                        <canvas id="trajectory-canvas" class="w-full h-64 md:h-80 rounded-lg bg-black"></canvas>
                        <p id="impact-status" class="text-center mt-4 text-lg font-medium text-red-400">IMPACT IMMINENT</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-white mb-4">Consequence Analysis</h3>
                            <button id="share-report-card" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg text-sm" aria-label="Share impact report card">Share Report</button>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Impact Energy</p>
                                <p id="energy-value" class="text-2xl font-bold text-orange-400">0 MT</p>
                            </div>
                            <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Crater Diameter</p>
                                <p id="crater-value" class="text-2xl font-bold text-orange-400">0 km</p>
                            </div>
                             <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Seismic Magnitude</p>
                                <p id="seismic-value" class="text-2xl font-bold text-orange-400">0.0</p>
                            </div>
                            <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Socio-Economic Impact</p>
                                <p id="socio-impact-value" class="text-2xl font-bold text-orange-400">LOW</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button id="generate-briefing" class="w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-lg mb-4 action-button" aria-label="Generate a detailed impact briefing" disabled>Generate Impact Briefing</button>
                            <div class="chart-container">
                                <canvas id="energy-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 md:mt-12 text-gray-500 text-sm">
            <p>A project for the 2025 NASA Space Apps Challenge. Inspired by data from NASA's NEO API and USGS environmental datasets.</p>
            <p>Project by Team Cosmic ðŸš€</p>
            <p>&copy; 2025 Meteor Madness Simulator</p>
        </footer>
    </div>
    
    <div id="briefing-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1001] hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-orange-400">Planetary Defense Briefing</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto flex-grow prose text-gray-300"></div>
        </div>
    </div>
    
    <div id="report-card-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1001] hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
             <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-orange-400">Impact Report Card</h3>
                <button id="close-report-card" class="text-gray-400 hover:text-white text-2xl" aria-label="Close report card">&times;</button>
            </div>
            <div id="report-card-content" class="p-6 text-gray-300 space-y-3"></div>
            <div class="p-4 border-t border-gray-700">
                <button id="copy-report-card" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" aria-label="Copy report card to clipboard">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <textarea id="clipboard-helper" class="absolute -left-full"></textarea>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                diameter: 140,
                velocity: 20,
                location: { name: 'Ocean', type: 'oceanic', regionCode: 'OCEAN' },
                mitigation: 'none',
                impactEnergy: 0,
                isAudioEnabled: false,
            };

            const dom = {
                audioModal: document.getElementById('audio-modal'),
                enableAudioBtn: document.getElementById('enable-audio'),
                briefingModal: document.getElementById('briefing-modal'),
                modalContent: document.getElementById('modal-content'),
                closeModalBtn: document.getElementById('close-modal'),
                reportCardModal: document.getElementById('report-card-modal'),
                reportCardContent: document.getElementById('report-card-content'),
                closeReportCardBtn: document.getElementById('close-report-card'),
                copyReportCardBtn: document.getElementById('copy-report-card'),
                clipboardHelper: document.getElementById('clipboard-helper'),
                loadNasaDataBtn: document.getElementById('load-nasa-data'),
                nasaDataContainer: document.getElementById('nasa-data-container'),
                nasaDataList: document.getElementById('nasa-data-list'),
                sizeSlider: document.getElementById('asteroid-size'),
                velocitySlider: document.getElementById('asteroid-velocity'),
                sizeValue: document.getElementById('size-value'),
                velocityValue: document.getElementById('velocity-value'),
                locationName: document.getElementById('location-name'),
                mitigationSelect: document.getElementById('mitigation-strategy'),
                mitigationStatus: document.getElementById('mitigation-status'),
                mitigationBriefingContainer: document.getElementById('mitigation-briefing-container'),
                mitigationTitle: document.getElementById('mitigation-title'),
                mitigationDescription: document.getElementById('mitigation-description'),
                mitigationDetails: document.getElementById('mitigation-details'),
                impactStatus: document.getElementById('impact-status'),
                energyValue: document.getElementById('energy-value'),
                craterValue: document.getElementById('crater-value'),
                seismicValue: document.getElementById('seismic-value'),
                socioImpactValue: document.getElementById('socio-impact-value'),
                generateBriefingBtn: document.getElementById('generate-briefing'),
                shareReportCardBtn: document.getElementById('share-report-card'),
                trajectoryCanvas: document.getElementById('trajectory-canvas'),
                energyChartCanvas: document.getElementById('energy-chart'),
            };
            
            let map, impactMarker;
            let energyChart;
            const t_ctx = dom.trajectoryCanvas.getContext('2d');
            const ASTEROID_DENSITY = 3000; // kg/m^3 for stony asteroids
            const NASA_API_KEY = 'aORJuyPR46Rb3kIpjSZJPDtZEZtos9OTBPTAqt5i';

            // Simplified grid to map lat/lng to geopolitical regions
            const GRID_COLS = 12;
            const GRID_ROWS = 6;
            const regionLookup = [
                ['OCEAN', 'NA', 'NA', 'NA', 'OCEAN', 'EU', 'EU', 'RU', 'RU', 'RU', 'OCEAN', 'OCEAN'],
                ['OCEAN', 'NA', 'NA', 'NA', 'OCEAN', 'EU', 'AF', 'SAS', 'EAS', 'EAS', 'OCEAN', 'OCEAN'],
                ['OCEAN', 'OCEAN', 'NA', 'SA', 'SA', 'AF', 'AF', 'AF', 'SAS', 'OCEAN', 'OC', 'OCEAN'],
                ['OCEAN', 'OCEAN', 'SA', 'SA', 'SA', 'OCEAN', 'AF', 'AF', 'OCEAN', 'OC', 'OC', 'OCEAN'],
                ['OCEAN', 'OCEAN', 'OCEAN', 'SA', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OC', 'OCEAN', 'OCEAN'],
                ['OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN', 'OCEAN']
            ];
            const regionData = {
                "NA": { name: "North America", popDensity: 2, devIndex: 3, type: 'inland' },
                "EU": { name: "Western Europe", popDensity: 3, devIndex: 3, type: 'coastal' },
                "RU": { name: "Northern Eurasia", popDensity: 1, devIndex: 2, type: 'inland' },
                "EAS": { name: "East Asia", popDensity: 3, devIndex: 2, type: 'coastal' },
                "SAS": { name: "South Asia", popDensity: 3, devIndex: 1, type: 'coastal' },
                "AF": { name: "Africa", popDensity: 2, devIndex: 1, type: 'inland' },
                "SA": { name: "South America", popDensity: 1, devIndex: 2, type: 'inland' },
                "OC": { name: "Oceania", popDensity: 1, devIndex: 3, type: 'coastal' },
                "OCEAN": { name: "Ocean", popDensity: 0, devIndex: 0, type: 'oceanic' },
            };

            const soundEngine = {
                uiClick: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 } }).toDestination(),
                success: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
                impact: new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination(),
                playClick() { if(appState.isAudioEnabled) this.uiClick.triggerAttackRelease('C5', '8n'); },
                playSuccess() { if(appState.isAudioEnabled) this.success.triggerAttackRelease('G5', '4n'); },
                playImpact() { if(appState.isAudioEnabled) this.impact.triggerAttackRelease('1n'); },
            };
            
            const mitigationBriefings = {
                kinetic_impactor: {
                    title: "Kinetic Impactor",
                    description: "A high-speed projectile strikes the asteroid to alter its trajectory through momentum transfer.",
                    details: `<p class="mt-2"><strong>Real-World Example:</strong> NASA's DART mission (2022).</p><ul><li><strong>Pros:</strong> Technology is proven.</li><li><strong>Cons:</strong> Requires precise targeting years in advance.</li></ul>`
                },
                gravity_tractor: {
                    title: "Gravity Tractor",
                    description: "A massive spacecraft's subtle gravitational pull gently tugs the asteroid onto a new course over a long period.",
                    details: `<p class="mt-2"><strong>Concept Status:</strong> Well-studied but not yet tested.</p><ul><li><strong>Pros:</strong> Highly precise and controllable.</li><li><strong>Cons:</strong> Extremely slow; only effective on smaller asteroids.</li></ul>`
                },
                laser_ablation: {
                    title: "Laser Ablation",
                    description: "A powerful laser vaporizes the asteroid's surface, creating a jet of gas that acts like a small rocket engine.",
                    details: `<p class="mt-2"><strong>Concept Status:</strong> A promising future technology.</p><ul><li><strong>Pros:</strong> No physical contact required.</li><li><strong>Cons:</strong> Requires an immense power source.</li></ul>`
                }
            };
            
            function generateImpactBriefing() {
                soundEngine.playClick();
                let briefingHTML = '';

                if (appState.mitigation !== 'none') {
                    const strategyName = appState.mitigation.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    briefingHTML = `
                        <h3>Threat Averted: Mitigation Success</h3>
                        <p>The selected mitigation strategy, <strong>${strategyName}</strong>, has successfully deflected the asteroid.</p>
                        <ul>
                            <li><strong>Outcome:</strong> No impact.</li>
                            <li><strong>Potential Threat:</strong> Asteroid with diameter ${appState.diameter}m and velocity ${appState.velocity}km/s.</li>
                            <li><strong>Target Region Saved:</strong> ${appState.location.name}</li>
                        </ul>
                        <p class="text-green-400 font-bold">Planetary defense systems performed nominally. The threat to the planet has been neutralized.</p>
                    `;
                } else {
                    const { location, impactEnergy } = appState;
                    const { crater, seismic } = calculateConsequences();
                    let environmentalDetail = '';
                    switch(location.type) {
                        case 'inland': environmentalDetail = 'Primary threat is a powerful atmospheric shockwave and widespread ejecta.'; break;
                        case 'coastal': environmentalDetail = 'A significant tsunami is the most severe threat, capable of inundating low-lying coastal regions.'; break;
                        case 'oceanic': environmentalDetail = 'A deep-ocean impact will generate a mega-tsunami with potential for trans-oceanic devastation.'; break;
                    }
                    briefingHTML = `<h3>Threat Summary</h3><p>Analysis of a simulated impact event targeting the <strong>${location.name}</strong> region.</p><h3>Calculated Physical Consequences</h3><ul><li><strong>Impact Energy:</strong> ${Number(impactEnergy).toLocaleString()} Megatons (MT).</li><li><strong>Estimated Crater Diameter:</strong> ${Number(crater).toLocaleString()} km.</li><li><strong>Equivalent Seismic Magnitude:</strong> ${seismic}.</li></ul><h3>Environmental Impact Analysis</h3><p>${environmentalDetail}</p>`;
                }
                
                dom.modalContent.innerHTML = briefingHTML;
                dom.briefingModal.classList.remove('hidden');
            }
            
            function updateMitigationBriefing() {
                const selectedStrategy = appState.mitigation;
                const briefingData = mitigationBriefings[selectedStrategy];
                if (briefingData) {
                    dom.mitigationTitle.textContent = briefingData.title;
                    dom.mitigationDescription.textContent = briefingData.description;
                    dom.mitigationDetails.innerHTML = briefingData.details;
                    dom.mitigationBriefingContainer.classList.add('visible');
                } else {
                    dom.mitigationBriefingContainer.classList.remove('visible');
                }
            }
            
            function drawTrajectory() {
                const w = dom.trajectoryCanvas.width = dom.trajectoryCanvas.clientWidth;
                const h = dom.trajectoryCanvas.height = dom.trajectoryCanvas.clientHeight;
                t_ctx.clearRect(0, 0, w, h);
                const earthRadius = Math.min(w, h) * 0.15;
                const earthX = w * 0.75, earthY = h / 2;
                t_ctx.fillStyle = '#3b82f6';
                t_ctx.beginPath();
                t_ctx.arc(earthX, earthY, earthRadius, 0, Math.PI * 2);
                t_ctx.fill();
                const startX = -20, startY = h / 2;
                let controlY, endX, endY;
                const mitigationEffect = { none: 0, kinetic_impactor: 1, gravity_tractor: 0.8, laser_ablation: 1.2 };
                const deflection = mitigationEffect[appState.mitigation];
                if (deflection > 0) {
                    controlY = h * (0.1 / deflection);
                    endY = earthY - earthRadius * (1.5 + deflection * 0.2);
                    endX = earthX;
                } else {
                    controlY = h * 0.4;
                    endX = earthX - earthRadius * 0.5;
                    endY = earthY;
                }
                t_ctx.strokeStyle = '#f97316';
                t_ctx.lineWidth = 2;
                t_ctx.setLineDash([5, 5]);
                t_ctx.beginPath();
                t_ctx.moveTo(startX, startY);
                t_ctx.quadraticCurveTo(w * 0.3, controlY, endX, endY);
                t_ctx.stroke();
                if (deflection === 0) {
                      t_ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                      t_ctx.beginPath();
                      t_ctx.arc(endX, endY, 15, 0, Math.PI * 2);
                      t_ctx.fill();
                }
            }
            
            function createChart() {
                energyChart = new Chart(dom.energyChartCanvas.getContext('2d'), {
                    type: 'bar',
                    data: { labels: ['Simulation', 'Tunguska (~15 MT)'], datasets: [{ data: [0, 15], backgroundColor: ['#f97316', '#3b82f6'] }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { type: 'logarithmic', title: { display: true, text: 'Energy (Megatons TNT) - Log Scale', color: '#9ca3af' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Impact Energy Comparison', color: '#e5e7eb' } } }
                });
            }

            function updateChart() {
                if(energyChart) {
                    energyChart.data.datasets[0].data[0] = appState.impactEnergy > 0 ? appState.impactEnergy : 0.01;
                    energyChart.update();
                }
            }

            async function fetchNasaData() {
                soundEngine.playClick();
                dom.nasaDataList.innerHTML = `<li>Loading...</li>`;
                dom.nasaDataContainer.classList.remove('hidden');
                // Set a fixed date based on the simulation's context (Oct 4, 2025) for consistent results.
                const today = new Date('2025-10-04T12:00:00Z');
                const endDate = new Date(today);
                endDate.setDate(today.getDate() + 7);
                const formatDate = (d) => d.toISOString().split('T')[0];
                const url = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${formatDate(today)}&end_date=${formatDate(endDate)}&api_key=${NASA_API_KEY}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const asteroids = Object.values(data.near_earth_objects).flat();
                    dom.nasaDataList.innerHTML = '';
                    if (asteroids.length === 0) {
                        dom.nasaDataList.innerHTML = `<li>No asteroids found in the next 7 days.</li>`;
                    } else {
                        asteroids.slice(0, 10).forEach(ast => {
                            const li = document.createElement('li');
                            li.className = 'p-2 rounded-md cursor-pointer nasa-item';
                            li.textContent = `${ast.name}`;
                            li.dataset.diameter = Math.round((ast.estimated_diameter.meters.estimated_diameter_min + ast.estimated_diameter.meters.estimated_diameter_max) / 2);
                            li.dataset.velocity = Math.round(ast.close_approach_data[0].relative_velocity.kilometers_per_second);
                            li.setAttribute('aria-label', `Load asteroid ${ast.name}`);
                            li.setAttribute('tabindex', '0');
                            dom.nasaDataList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Failed to fetch NASA data:", error);
                    dom.nasaDataList.innerHTML = `<li>Error loading data.</li>`;
                }
            }
            
            function showReportCard() {
                soundEngine.playClick();
                const outcome = appState.mitigation !== 'none' ? 'SUCCESS: THREAT AVERTED' : 'FAILURE: CATASTROPHIC IMPACT';
                const color = outcome.startsWith('SUCCESS') ? 'text-green-400' : 'text-red-400';
                const { energy } = calculateConsequences();
                dom.reportCardContent.innerHTML = `<p class="text-xl font-bold ${color}">${outcome}</p><p><strong>Target Region:</strong> ${appState.location.name}</p><p><strong>Asteroid Size:</strong> ${appState.diameter} m</p><p><strong>Impact Velocity:</strong> ${appState.velocity} km/s</p><p><strong>Mitigation Used:</strong> ${appState.mitigation.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p><p><strong>Resulting Energy:</strong> ${Number(energy).toLocaleString()} MT</p>`;
                dom.reportCardModal.classList.remove('hidden');
            }

            function initMap() {
                map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    maxZoom: 10,
                    minZoom: 2
                }).addTo(map);
                map.on('click', onMapClick);
            }

            function onMapClick(e) {
                if(impactMarker) { map.removeLayer(impactMarker); }
                impactMarker = L.circle(e.latlng, { color: '#f97316', fillColor: '#f97316', fillOpacity: 0.5, radius: 50000 }).addTo(map);

                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                const col = Math.floor(((lng + 180) / 360) * GRID_COLS);
                const row = Math.floor(((-lat + 90) / 180) * GRID_ROWS);
                const safeRow = Math.max(0, Math.min(row, GRID_ROWS - 1));
                const safeCol = Math.max(0, Math.min(col, GRID_COLS - 1));
                const regionCode = regionLookup[safeRow][safeCol];
                const region = regionData[regionCode];

                appState.location = {
                    name: region.name,
                    type: region.type,
                    regionCode: regionCode
                };
                
                soundEngine.playClick();
                updateUI();
            }

            function calculateConsequences() {
                dom.generateBriefingBtn.disabled = false;
                if (appState.mitigation !== 'none') {
                    appState.impactEnergy = 0;
                    return { energy: 0, socioImpact: 'NONE', crater: 0, seismic: '0.0' };
                }
                
                const radius = appState.diameter / 2;
                const volume = (4/3) * Math.PI * Math.pow(radius, 3);
                const mass = volume * ASTEROID_DENSITY;
                const velocityMetersPerSecond = appState.velocity * 1000;
                const kineticEnergyJoules = 0.5 * mass * Math.pow(velocityMetersPerSecond, 2);
                const energyMegatons = kineticEnergyJoules / (4.184 * Math.pow(10, 15));
                appState.impactEnergy = energyMegatons;
                
                // Simplified Holsapple-Schmidt scaling for crater size
                const craterDiameterKm = 0.02 * Math.pow(kineticEnergyJoules, 1/3.4) / 1000;
                // Simplified seismic magnitude calculation
                const seismicMagnitude = 0.67 * (Math.log10(kineticEnergyJoules)) - 5.87;

                const geoData = regionData[appState.location.regionCode];
                const baseImpact = Math.log10(appState.impactEnergy + 1);
                const socioEconomicScore = baseImpact * geoData.popDensity * geoData.devIndex;
                
                let socioImpactLevel;
                if(socioEconomicScore > 15) socioImpactLevel = 'CATASTROPHIC';
                else if (socioEconomicScore > 10) socioImpactLevel = 'SEVERE';
                else if (socioEconomicScore > 5) socioImpactLevel = 'HIGH';
                else if (socioEconomicScore > 1) socioImpactLevel = 'MODERATE';
                else socioImpactLevel = 'LOW';
                
                if(appState.location.type === 'oceanic') socioImpactLevel = 'LOW';

                return {
                    energy: energyMegatons.toFixed(2),
                    socioImpact: socioImpactLevel,
                    crater: craterDiameterKm.toFixed(2),
                    seismic: seismicMagnitude > 0 ? seismicMagnitude.toFixed(1) : "0.0"
                };
            }

            function updateUI() {
                const { energy, socioImpact, crater, seismic } = calculateConsequences();
                
                dom.locationName.textContent = appState.location.name;
                dom.energyValue.textContent = `${Number(energy).toLocaleString()} MT`;
                dom.craterValue.textContent = `${Number(crater).toLocaleString()} km`;
                dom.seismicValue.textContent = seismic;
                dom.socioImpactValue.textContent = socioImpact;
                
                const impactColorClasses = {
                    'CATASTROPHIC': 'text-red-500', 'SEVERE': 'text-red-400', 'HIGH': 'text-orange-400',
                    'MODERATE': 'text-yellow-400', 'LOW': 'text-green-400', 'NONE': 'text-gray-400'
                };
                dom.socioImpactValue.className = `text-2xl font-bold ${impactColorClasses[socioImpact] || 'text-gray-400'}`;
                
                dom.sizeSlider.value = appState.diameter;
                dom.velocitySlider.value = appState.velocity;
                dom.sizeValue.textContent = `${appState.diameter} m`;
                dom.velocityValue.textContent = `${appState.velocity} km/s`;
                dom.mitigationSelect.value = appState.mitigation;
                
                const mitigationText = {
                    none: 'No mitigation strategy selected.',
                    kinetic_impactor: 'Kinetic Impactor armed. Awaiting deployment.',
                    gravity_tractor: 'Gravity Tractor engaged. Slowly altering trajectory.',
                    laser_ablation: 'Laser Ablation system online. Vaporizing surface to create thrust.'
                };
                dom.mitigationStatus.textContent = mitigationText[appState.mitigation];

                if (appState.mitigation !== 'none') {
                    dom.mitigationStatus.classList.remove('text-gray-400');
                    dom.mitigationStatus.classList.add('text-green-400');
                    dom.impactStatus.textContent = 'ASTEROID DEFLECTED';
                    dom.impactStatus.classList.remove('text-red-400');
                    dom.impactStatus.classList.add('text-green-400');
                } else {
                    dom.mitigationStatus.classList.add('text-gray-400');
                    dom.mitigationStatus.classList.remove('text-green-400');
                    dom.impactStatus.textContent = 'IMPACT IMMINENT';
                    dom.impactStatus.classList.add('text-red-400');
                    dom.impactStatus.classList.remove('text-green-400');
                }
                
                drawTrajectory();
                updateChart();
            }
            
            function main() {
                dom.enableAudioBtn.addEventListener('click', () => {
                    Tone.start();
                    appState.isAudioEnabled = true;
                    dom.audioModal.style.display = 'none';
                    soundEngine.playSuccess();
                });
                dom.sizeSlider.addEventListener('input', (e) => { appState.diameter = parseInt(e.target.value); updateUI(); });
                dom.velocitySlider.addEventListener('input', (e) => { appState.velocity = parseInt(e.target.value); updateUI(); });
                dom.mitigationSelect.addEventListener('change', (e) => {
                    appState.mitigation = e.target.value;
                    soundEngine.playClick();
                    if (appState.mitigation !== 'none') { soundEngine.playSuccess(); }
                    updateUI();
                    updateMitigationBriefing();
                });
                dom.loadNasaDataBtn.addEventListener('click', fetchNasaData);
                dom.nasaDataList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI' && e.target.dataset.diameter) {
                        appState.diameter = parseInt(e.target.dataset.diameter);
                        appState.velocity = parseInt(e.target.dataset.velocity);
                        soundEngine.playClick();
                        dom.nasaDataContainer.classList.add('hidden');
                        updateUI();
                    }
                });
                dom.generateBriefingBtn.addEventListener('click', generateImpactBriefing);
                dom.closeModalBtn.addEventListener('click', () => dom.briefingModal.classList.add('hidden'));
                dom.shareReportCardBtn.addEventListener('click', showReportCard);
                dom.closeReportCardBtn.addEventListener('click', () => dom.reportCardModal.classList.add('hidden'));
                dom.copyReportCardBtn.addEventListener('click', () => {
                    const text = dom.reportCardContent.innerText;
                    dom.clipboardHelper.value = `â˜„ï¸ Meteor Madness Simulation Report â˜„ï¸\n\n${text}`;
                    dom.clipboardHelper.select();
                    document.execCommand('copy');
                    soundEngine.playSuccess();
                });
                window.addEventListener('resize', () => {
                    drawTrajectory();
                });
                
                initMap();
                createChart();
                updateUI();
            }

            main();
        });
    </script>
</body>
</html>

