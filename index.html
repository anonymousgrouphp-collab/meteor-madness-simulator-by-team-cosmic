<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteor Madness - Advanced Impact Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Cosmic Neutrals -->
    <!-- Application Structure Plan: The application is designed as an interactive, task-oriented dashboard with two primary modes: a creative 'Sandbox' and a goal-oriented 'Challenge Mode'. This structure caters to different user motivationsâ€”free exploration vs. problem-solving. The core user flow is centered on the control panel, a central visualizer, and a consequence analysis section. Features like the interactive global map and live NASA data loading enhance realism. The core analysis feature is an automatically generated, data-driven impact briefing that provides instant, reliable feedback to the user without external dependencies. A new context-sensitive mitigation briefing panel provides on-demand educational content. -->
    <!-- Visualization & Content Choices: 
        - Live NASA Data: Report Info -> Goal: Inform/Organize -> Viz: Interactive List -> Interaction: Click to load -> Justification: Connects the simulation to real scientific data.
        - Global Impact Map: Report Info -> Goal: Organize/Inform -> Viz: 2D Canvas Map -> Interaction: Click to select impact point -> Justification: Increases user immersion and provides geographical context.
        - Automatic Impact Briefing: Report Info -> Goal: Synthesize/Inform -> Viz: Formatted Modal Text -> Interaction: Button click -> Justification: Provides instant, reliable, and detailed analysis of the simulation results.
        - Mitigation Briefing: Report Info -> Goal: Inform -> Viz: Dynamic Text Panel -> Interaction: Select from dropdown -> Justification: Provides immediate, context-sensitive educational information about planetary defense technologies, directly addressing a core challenge goal.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 350px; max-height: 400px; }
        .slider-thumb-orange::-webkit-slider-thumb { background-color: #f97316; }
        .slider-thumb-orange::-moz-range-thumb { background-color: #f97316; }
        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover { transform: translateY(-px); box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
        .prose h3 { color: #fb923c; margin-bottom: 0.5rem; font-size: 1.1em; }
        .prose ul { list-style-position: inside; padding-left: 0; }
        .prose li, .prose p { margin-bottom: 0.75rem; }
        .mode-button.active { background-color: #ea580c; color: white; }
        .nasa-item:hover { background-color: #3f3f46; }
        button:focus, select:focus, input[type=range]:focus, input[type=checkbox]:focus {
            outline: 2px solid #fb923c;
            outline-offset: 2px;
        }
        .briefing-panel {
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .briefing-panel.visible {
            max-height: 500px; /* Or a sufficiently large value */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div id="audio-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100]">
        <div class="text-center p-8">
            <h2 class="text-3xl font-bold mb-4 text-white">Enable Audio?</h2>
            <p class="text-gray-300 mb-6">This experience uses sound effects for better immersion.</p>
            <button id="enable-audio" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Yes, enable audio</button>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-6xl font-bold text-white tracking-tighter">Meteor Madness</h1>
            <p class="text-lg md:text-xl text-gray-400 mt-2">Advanced Asteroid Impact & Mitigation Simulator</p>
        </header>

        <main>
            <section id="scenario" class="bg-gray-800 p-6 rounded-2xl mb-8 md:mb-12 shadow-2xl border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="scenario-title" class="text-2xl font-bold text-orange-400">Sandbox Mode</h2>
                    <div class="flex space-x-2 bg-gray-700 p-1 rounded-lg">
                        <button id="mode-sandbox" class="mode-button active px-4 py-1 text-sm font-semibold rounded-md" aria-label="Switch to Sandbox Mode">Sandbox</button>
                        <button id="mode-challenge" class="mode-button px-4 py-1 text-sm font-semibold rounded-md text-gray-300" aria-label="Switch to Challenge Mode">Challenge</button>
                    </div>
                </div>
                <p id="scenario-description" class="text-gray-300">Explore freely in Sandbox mode. Adjust all parameters to simulate any scenario you can imagine. Or, switch to Challenge Mode for a specific mission.</p>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="controls" class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700 space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Load Data</h3>
                        <button id="load-nasa-data" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" aria-label="Load real asteroid data from NASA">Load Real Asteroids (Next 7 Days)</button>
                        <div id="nasa-data-container" class="mt-4 max-h-40 overflow-y-auto hidden">
                            <ul id="nasa-data-list" class="text-sm space-y-1"></ul>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Impact Parameters</h3>
                        <div>
                            <label for="asteroid-size" class="block text-sm font-medium text-gray-300">Asteroid Diameter (meters)</label>
                            <input id="asteroid-size" type="range" min="10" max="1000" value="140" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb-orange" aria-label="Adjust asteroid diameter">
                            <span id="size-value" class="text-orange-400 font-mono text-center block mt-2">140 m</span>
                        </div>
                        <div class="mt-4">
                            <label for="asteroid-velocity" class="block text-sm font-medium text-gray-300">Impact Velocity (km/s)</label>
                            <input id="asteroid-velocity" type="range" min="10" max="70" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb-orange" aria-label="Adjust asteroid velocity">
                            <span id="velocity-value" class="text-orange-400 font-mono text-center block mt-2">20 km/s</span>
                        </div>
                    </div>

                     <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Impact Location</h3>
                         <canvas id="map-canvas" class="w-full h-48 rounded-lg bg-blue-900/50 cursor-pointer border-2 border-transparent hover:border-orange-500" aria-label="Interactive world map. Click to set impact location."></canvas>
                         <p class="text-center text-sm text-gray-400 mt-2">Click map to set target. Current: <span id="location-value" class="font-bold text-orange-400">Inland</span></p>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-3">Mitigation Systems</h3>
                        <div>
                           <label for="mitigation-strategy" class="block text-sm font-medium text-gray-300">Select Strategy</label>
                           <select id="mitigation-strategy" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 mt-1" aria-label="Select a mitigation strategy">
                               <option value="none">None (No Action)</option>
                               <option value="kinetic_impactor">Kinetic Impactor</option>
                               <option value="gravity_tractor">Gravity Tractor</option>
                               <option value="laser_ablation">Laser Ablation</option>
                           </select>
                       </div>
                       <p id="mitigation-status" class="text-sm mt-2 text-gray-400">No mitigation strategy selected.</p>
                       <!-- NEW: Mitigation Briefing Panel -->
                       <div id="mitigation-briefing-container" class="briefing-panel mt-4 bg-gray-900/50 p-4 rounded-lg prose text-gray-300 text-sm">
                           <h4 id="mitigation-title" class="text-orange-400 font-bold"></h4>
                           <p id="mitigation-description"></p>
                           <div id="mitigation-details"></div>
                       </div>
                    </div>
                </div>

                <div id="visuals-analysis" class="lg:col-span-2 space-y-8">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Trajectory & Impact Visualizer</h3>
                         <canvas id="trajectory-canvas" class="w-full h-64 md:h-80 rounded-lg bg-black"></canvas>
                         <p id="impact-status" class="text-center mt-4 text-lg font-medium text-red-400">IMPACT IMMINENT</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-white mb-4">Consequence Analysis</h3>
                            <button id="share-report-card" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg text-sm" aria-label="Share impact report card">Share Report</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Impact Energy</p>
                                <p id="energy-value" class="text-2xl font-bold text-orange-400">0 MT</p>
                            </div>
                             <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Crater Diameter</p>
                                <p id="crater-value" class="text-2xl font-bold text-orange-400">0 km</p>
                            </div>
                             <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Seismic Magnitude</p>
                                <p id="seismic-value" class="text-2xl font-bold text-orange-400">0.0</p>
                            </div>
                             <div class="text-center bg-gray-900/50 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Primary Hazard</p>
                                <p id="hazard-value" class="text-2xl font-bold text-orange-400">---</p>
                            </div>
                        </div>
                        <div class="mt-6">
                             <button id="generate-briefing" class="w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-lg mb-4 action-button" aria-label="Generate a detailed impact briefing" disabled>Generate Impact Briefing</button>
                             <div class="chart-container">
                                <canvas id="energy-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 md:mt-12 text-gray-500 text-sm">
            <p>A project for the 2025 NASA Space Apps Challenge. Inspired by data from NASA's NEO API and USGS environmental datasets.</p>
            <p>Project by Team Cosmic ðŸš€</p>
            <p>&copy; 2025 Meteor Madness Simulator</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="briefing-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-orange-400">Planetary Defense Briefing</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto flex-grow prose text-gray-300"></div>
        </div>
    </div>
    
    <div id="report-card-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
             <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-orange-400">Impact Report Card</h3>
                <button id="close-report-card" class="text-gray-400 hover:text-white text-2xl" aria-label="Close report card">&times;</button>
            </div>
            <div id="report-card-content" class="p-6 text-gray-300 space-y-3"></div>
            <div class="p-4 border-t border-gray-700">
                <button id="copy-report-card" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" aria-label="Copy report card to clipboard">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <textarea id="clipboard-helper" class="absolute -left-full"></textarea>

    <script type="module">
        // --- Main Application Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                mode: 'sandbox',
                diameter: 140,
                velocity: 20,
                location: 'inland',
                mitigation: 'none',
                impactEnergy: 0,
                isAudioEnabled: false,
            };

            // --- DOM Element Cache ---
            const dom = {
                audioModal: document.getElementById('audio-modal'),
                enableAudioBtn: document.getElementById('enable-audio'),
                briefingModal: document.getElementById('briefing-modal'),
                modalContent: document.getElementById('modal-content'),
                closeModalBtn: document.getElementById('close-modal'),
                reportCardModal: document.getElementById('report-card-modal'),
                reportCardContent: document.getElementById('report-card-content'),
                closeReportCardBtn: document.getElementById('close-report-card'),
                copyReportCardBtn: document.getElementById('copy-report-card'),
                clipboardHelper: document.getElementById('clipboard-helper'),
                modeSandboxBtn: document.getElementById('mode-sandbox'),
                modeChallengeBtn: document.getElementById('mode-challenge'),
                scenarioTitle: document.getElementById('scenario-title'),
                scenarioDescription: document.getElementById('scenario-description'),
                loadNasaDataBtn: document.getElementById('load-nasa-data'),
                nasaDataContainer: document.getElementById('nasa-data-container'),
                nasaDataList: document.getElementById('nasa-data-list'),
                sizeSlider: document.getElementById('asteroid-size'),
                velocitySlider: document.getElementById('asteroid-velocity'),
                sizeValue: document.getElementById('size-value'),
                velocityValue: document.getElementById('velocity-value'),
                locationValue: document.getElementById('location-value'),
                mitigationSelect: document.getElementById('mitigation-strategy'),
                mitigationStatus: document.getElementById('mitigation-status'),
                // NEW: Mitigation Briefing elements
                mitigationBriefingContainer: document.getElementById('mitigation-briefing-container'),
                mitigationTitle: document.getElementById('mitigation-title'),
                mitigationDescription: document.getElementById('mitigation-description'),
                mitigationDetails: document.getElementById('mitigation-details'),
                impactStatus: document.getElementById('impact-status'),
                energyValue: document.getElementById('energy-value'),
                craterValue: document.getElementById('crater-value'),
                seismicValue: document.getElementById('seismic-value'),
                hazardValue: document.getElementById('hazard-value'),
                generateBriefingBtn: document.getElementById('generate-briefing'),
                shareReportCardBtn: document.getElementById('share-report-card'),
                trajectoryCanvas: document.getElementById('trajectory-canvas'),
                mapCanvas: document.getElementById('map-canvas'),
                energyChartCanvas: document.getElementById('energy-chart'),
            };

            const t_ctx = dom.trajectoryCanvas.getContext('2d');
            const m_ctx = dom.mapCanvas.getContext('2d');
            const offscreenMapCanvas = document.createElement('canvas');
            const offscreen_m_ctx = offscreenMapCanvas.getContext('2d');
            let energyChart;
            
            const ASTEROID_DENSITY = 3000;
            const NASA_API_KEY = 'DEMO_KEY'; 

            const soundEngine = {
                uiClick: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 } }).toDestination(),
                success: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
                impact: new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination(),
                playClick() { if(appState.isAudioEnabled) this.uiClick.triggerAttackRelease('C5', '8n'); },
                playSuccess() { if(appState.isAudioEnabled) this.success.triggerAttackRelease('G5', '4n'); },
                playImpact() { if(appState.isAudioEnabled) this.impact.triggerAttackRelease('1n'); },
            };

            // NEW: Mitigation Briefing Content
            const mitigationBriefings = {
                kinetic_impactor: {
                    title: "Kinetic Impactor",
                    description: "This strategy involves striking the asteroid with a high-speed projectile to alter its trajectory through momentum transfer. It's like a cosmic game of billiards.",
                    details: `
                        <p class="mt-2"><strong>Real-World Example:</strong> NASA's DART (Double Asteroid Redirection Test) mission successfully demonstrated this technology in 2022.</p>
                        <ul>
                            <li><strong>Pros:</strong> Technology is proven and relatively straightforward.</li>
                            <li><strong>Cons:</strong> Requires precise targeting years in advance; effectiveness depends on the asteroid's composition.</li>
                        </ul>
                    `
                },
                gravity_tractor: {
                    title: "Gravity Tractor",
                    description: "A massive spacecraft is positioned near the asteroid. Over a long period (years to decades), its subtle gravitational pull gently tugs the asteroid onto a new, safe course.",
                     details: `
                        <p class="mt-2"><strong>Concept Status:</strong> This is a well-studied concept that relies on fundamental physics but has not yet been tested in a dedicated mission.</p>
                        <ul>
                            <li><strong>Pros:</strong> Highly precise and controllable, making it very safe.</li>
                            <li><strong>Cons:</strong> Extremely slow process; only effective on smaller asteroids (under 500m).</li>
                        </ul>
                    `
                },
                laser_ablation: {
                    title: "Laser Ablation",
                    description: "A powerful laser is focused on the asteroid's surface, heating it until the rock vaporizes. This creates a jet of gas, which acts like a small rocket engine, pushing the asteroid.",
                     details: `
                        <p class="mt-2"><strong>Concept Status:</strong> A promising future technology currently in the conceptual and laboratory testing phase.</p>
                        <ul>
                            <li><strong>Pros:</strong> No physical contact required; thrust can be adjusted by varying laser power.</li>
                            <li><strong>Cons:</strong> Requires an immense power source; less effective on rapidly rotating asteroids.</li>
                        </ul>
                    `
                }
            };

            function switchMode(newMode) {
                appState.mode = newMode;
                soundEngine.playClick();
                if (newMode === 'sandbox') {
                    dom.modeSandboxBtn.classList.add('active');
                    dom.modeChallengeBtn.classList.remove('active');
                    dom.scenarioTitle.textContent = "Sandbox Mode";
                    dom.scenarioDescription.textContent = "Explore freely in Sandbox mode. Adjust all parameters to simulate any scenario you can imagine. Or, switch to Challenge Mode for a specific mission.";
                    setControlsEnabled(true);
                } else {
                    dom.modeSandboxBtn.classList.remove('active');
                    dom.modeChallengeBtn.classList.add('active');
                    dom.scenarioTitle.textContent = "Challenge: The City-Killer";
                    dom.scenarioDescription.textContent = "A 300m asteroid is on a direct collision course with a major coastal city! Velocity is 25 km/s. You must select and deploy a mitigation strategy to save the population. The fate of millions is in your hands.";
                    appState.diameter = 300;
                    appState.velocity = 25;
                    appState.location = 'coastal';
                    appState.mitigation = 'none';
                    setControlsEnabled(false);
                }
                updateUI();
                updateMitigationBriefing(); // Update briefing on mode switch
            }

            function setControlsEnabled(isEnabled) {
                dom.sizeSlider.disabled = !isEnabled;
                dom.velocitySlider.disabled = !isEnabled;
                dom.mapCanvas.style.pointerEvents = isEnabled ? 'auto' : 'none';
                dom.loadNasaDataBtn.disabled = !isEnabled;
            }

            function generateImpactBriefing() {
                const { diameter, velocity, location, impactEnergy } = appState;
                const { crater, seismic } = calculateConsequences();

                let environmentalDetail = '';
                switch(location) {
                    case 'inland': environmentalDetail = 'The primary environmental concern is a powerful atmospheric shockwave and widespread ejecta, potentially triggering regional wildfires. Long-term climate effects from dust injection are possible but depend on impact angle and geology.'; break;
                    case 'coastal': environmentalDetail = 'A significant tsunami is the most severe threat, capable of inundating low-lying coastal regions hundreds of kilometers from the impact site. The combination of seismic shock and water displacement presents a complex disaster scenario.'; break;
                    case 'oceanic': environmentalDetail = 'A deep-ocean impact will generate a mega-tsunami with potential for trans-oceanic devastation. While the initial atmospheric disturbance is lessened by the water, the subsequent wave energy is a threat to all surrounding coastlines.'; break;
                }

                const briefingHTML = `
                    <h3>Threat Summary</h3>
                    <p>Analysis of a simulated impact event involving a Near-Earth Object (NEO) with a diameter of <strong>${diameter} m</strong> and an impact velocity of <strong>${velocity} km/s</strong>.</p>
                    <h3>Calculated Consequences</h3>
                    <ul>
                        <li><strong>Impact Energy:</strong> ${Number(impactEnergy).toLocaleString()} Megatons (MT) of TNT equivalent.</li>
                        <li><strong>Estimated Crater Diameter:</strong> ${Number(crater).toLocaleString()} km.</li>
                        <li><strong>Equivalent Seismic Magnitude:</strong> ${seismic} on the Richter scale.</li>
                    </ul>
                    <h3>Environmental Impact Analysis</h3>
                    <p>The impact is projected to occur in a/an <strong>${location}</strong> region. ${environmentalDetail}</p>
                    <h3>Scale Comparison</h3>
                    <p>The energy released is approximately <strong>${(impactEnergy / 15).toFixed(1)} times</strong> more powerful than the 1908 Tunguska event, which flattened over 2,000 square kilometers of forest.</p>
                `;

                dom.modalContent.innerHTML = briefingHTML;
                dom.briefingModal.classList.remove('hidden');
                soundEngine.playClick();
            }

            function calculateConsequences() {
                if (appState.mitigation !== 'none') {
                    appState.impactEnergy = 0;
                    dom.generateBriefingBtn.disabled = true;
                    return { energy: 0, crater: 0, seismic: 0 };
                }
                dom.generateBriefingBtn.disabled = false;
                const radius = appState.diameter / 2;
                const volume = (4/3) * Math.PI * Math.pow(radius, 3);
                const mass = volume * ASTEROID_DENSITY;
                const velocityMetersPerSecond = appState.velocity * 1000;
                const kineticEnergyJoules = 0.5 * mass * Math.pow(velocityMetersPerSecond, 2);
                const energyMegatons = kineticEnergyJoules / (4.184 * Math.pow(10, 15));
                appState.impactEnergy = energyMegatons;
                const craterDiameterKm = 0.02 * Math.pow(kineticEnergyJoules, 1/3.4) / 1000;
                const seismicMagnitude = 0.67 * (Math.log10(kineticEnergyJoules)) - 5.87;
                return {
                    energy: energyMegatons.toFixed(2),
                    crater: craterDiameterKm.toFixed(2),
                    seismic: seismicMagnitude > 0 ? seismicMagnitude.toFixed(1) : "0.0",
                };
            }

            function updateUI() {
                const { energy, crater, seismic } = calculateConsequences();

                dom.sizeSlider.value = appState.diameter;
                dom.velocitySlider.value = appState.velocity;
                dom.sizeValue.textContent = `${appState.diameter} m`;
                dom.velocityValue.textContent = `${appState.velocity} km/s`;
                dom.locationValue.textContent = appState.location.charAt(0).toUpperCase() + appState.location.slice(1);
                dom.mitigationSelect.value = appState.mitigation;
                
                const mitigationText = {
                    none: 'No mitigation strategy selected.',
                    kinetic_impactor: 'Kinetic Impactor armed. Awaiting deployment.',
                    gravity_tractor: 'Gravity Tractor engaged. Slowly altering trajectory.',
                    laser_ablation: 'Laser Ablation system online. Vaporizing surface to create thrust.'
                };
                dom.mitigationStatus.textContent = mitigationText[appState.mitigation];

                if (appState.mitigation !== 'none') {
                    dom.mitigationStatus.classList.remove('text-gray-400');
                    dom.mitigationStatus.classList.add('text-green-400');
                    dom.impactStatus.textContent = 'ASTEROID DEFLECTED';
                    dom.impactStatus.classList.remove('text-red-400');
                    dom.impactStatus.classList.add('text-green-400');
                    dom.energyValue.textContent = '0 MT';
                    dom.craterValue.textContent = '0 km';
                    dom.seismicValue.textContent = '0.0';
                    dom.hazardValue.textContent = 'None';
                    if(appState.mode === 'challenge') {
                        dom.scenarioDescription.textContent = "SUCCESS! The coastal city is safe. Your decisive action averted a catastrophe. You have proven that with science and quick thinking, humanity can defend itself from cosmic threats.";
                        dom.scenarioDescription.classList.add('text-green-300');
                    }
                } else {
                    dom.mitigationStatus.classList.add('text-gray-400');
                    dom.mitigationStatus.classList.remove('text-green-400');
                    dom.impactStatus.textContent = 'IMPACT IMMINENT';
                    dom.impactStatus.classList.add('text-red-400');
                    dom.impactStatus.classList.remove('text-green-400');
                    dom.energyValue.textContent = `${Number(energy).toLocaleString()} MT`;
                    dom.craterValue.textContent = `${Number(crater).toLocaleString()} km`;
                    dom.seismicValue.textContent = `${seismic}`;
                     if(appState.mode === 'challenge') {
                         dom.scenarioDescription.textContent = "FAILURE! The asteroid has impacted the coastal city, causing untold devastation. A different strategy was needed. Reset the simulation by switching modes and try again.";
                         dom.scenarioDescription.classList.add('text-red-400');
                     } else {
                         dom.scenarioDescription.classList.remove('text-red-400', 'text-green-300');
                     }
                }

                switch(appState.location) {
                    case 'inland': dom.hazardValue.textContent = 'Shockwave'; break;
                    case 'coastal': dom.hazardValue.textContent = 'Tsunami'; break;
                    case 'oceanic': dom.hazardValue.textContent = 'Mega-Tsunami'; break;
                }
                
                drawTrajectory();
                updateChart();
            }

            // MODIFIED: updateMitigationBriefing
            function updateMitigationBriefing() {
                const selectedStrategy = appState.mitigation;
                const briefingData = mitigationBriefings[selectedStrategy];

                if (briefingData) {
                    dom.mitigationTitle.textContent = briefingData.title;
                    dom.mitigationDescription.textContent = briefingData.description;
                    dom.mitigationDetails.innerHTML = briefingData.details;
                    dom.mitigationBriefingContainer.classList.add('visible');
                } else {
                    dom.mitigationBriefingContainer.classList.remove('visible');
                }
            }
            
            function drawTrajectory() {
                const w = dom.trajectoryCanvas.width = dom.trajectoryCanvas.clientWidth;
                const h = dom.trajectoryCanvas.height = dom.trajectoryCanvas.clientHeight;
                t_ctx.clearRect(0, 0, w, h);
                const earthRadius = Math.min(w, h) * 0.15;
                const earthX = w * 0.75, earthY = h / 2;
                t_ctx.fillStyle = '#3b82f6';
                t_ctx.beginPath();
                t_ctx.arc(earthX, earthY, earthRadius, 0, Math.PI * 2);
                t_ctx.fill();
                const startX = -20, startY = h / 2;
                
                let controlY, endX, endY;
                const mitigationEffect = { none: 0, kinetic_impactor: 1, gravity_tractor: 0.8, laser_ablation: 1.2 };
                const deflection = mitigationEffect[appState.mitigation];

                if (deflection > 0) {
                    controlY = h * (0.1 / deflection);
                    endY = earthY - earthRadius * (1.5 + deflection * 0.2);
                    endX = earthX;
                } else {
                    controlY = h * 0.4;
                    endX = earthX - earthRadius * 0.5;
                    endY = earthY;
                }

                t_ctx.strokeStyle = '#f97316';
                t_ctx.lineWidth = 2;
                t_ctx.setLineDash([5, 5]);
                t_ctx.beginPath();
                t_ctx.moveTo(startX, startY);
                t_ctx.quadraticCurveTo(w * 0.3, controlY, endX, endY);
                t_ctx.stroke();
                
                if (deflection === 0) {
                     t_ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                     t_ctx.beginPath();
                     t_ctx.arc(endX, endY, 15, 0, Math.PI * 2);
                     t_ctx.fill();
                }
            }
            
            const worldPath = new Path2D("M8,80 L20,70 L45,60 L70,62 L90,75 L110,80 L130,80 L150,70 L170,55 L180,45 L190,30 L220,25 L240,28 L260,35 L280,45 L290,60 L280,75 L270,90 L260,105 L240,115 L220,120 L200,118 L180,115 L160,110 L140,112 L120,120 L100,125 L80,120 L60,110 L40,95 L20,85 Z M20,10 L40,5 L60,8 L70,15 L60,25 L50,30 L40,25 Z M285,15 L300,10 L310,15 L315,25 L305,30 L295,25 Z");

            function drawWorldMap() {
                const w = dom.mapCanvas.width = dom.mapCanvas.clientWidth;
                const h = dom.mapCanvas.height = dom.mapCanvas.clientHeight;
                offscreenMapCanvas.width = w;
                offscreenMapCanvas.height = h;

                m_ctx.fillStyle = '#0c4a6e';
                m_ctx.fillRect(0, 0, w, h);
                offscreen_m_ctx.fillStyle = '#0000FF';
                offscreen_m_ctx.fillRect(0, 0, w, h);

                m_ctx.save();
                offscreen_m_ctx.save();
                const scaleX = w / 320;
                const scaleY = h / 140;
                m_ctx.scale(scaleX, scaleY);
                offscreen_m_ctx.scale(scaleX, scaleY);
                m_ctx.fillStyle = '#166534';
                offscreen_m_ctx.fillStyle = '#00FF00';
                m_ctx.fill(worldPath);
                offscreen_m_ctx.fill(worldPath);
                m_ctx.restore();
                offscreen_m_ctx.restore();
            }

            function getImpactLocation(x, y) {
                const pixel = offscreen_m_ctx.getImageData(x, y, 1, 1).data;
                const isLand = pixel[1] === 255;
                if (isLand) {
                    for(let i = -3; i <= 3; i++) {
                        for(let j = -3; j <= 3; j++) {
                            if (i === 0 && j === 0) continue;
                            const adjacentPixel = offscreen_m_ctx.getImageData(x + i, y + j, 1, 1).data;
                            if (adjacentPixel[2] === 255) return 'coastal';
                        }
                    }
                    return 'inland';
                }
                return 'oceanic';
            }

            function createChart() {
                energyChart = new Chart(dom.energyChartCanvas.getContext('2d'), {
                    type: 'bar',
                    data: { labels: ['Simulation', 'Tunguska (~15 MT)'], datasets: [{ data: [0, 15], backgroundColor: ['#f97316', '#3b82f6'] }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { type: 'logarithmic', title: { display: true, text: 'Energy (Megatons TNT) - Log Scale', color: '#9ca3af' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Impact Energy Comparison', color: '#e5e7eb' } } }
                });
            }

            function updateChart() {
                energyChart.data.datasets[0].data[0] = appState.impactEnergy > 0 ? appState.impactEnergy : 0.01;
                energyChart.update();
            }

            async function fetchNasaData() {
                soundEngine.playClick();
                dom.nasaDataList.innerHTML = `<li>Loading...</li>`;
                dom.nasaDataContainer.classList.remove('hidden');
                const today = new Date();
                const endDate = new Date();
                endDate.setDate(today.getDate() + 7);
                const formatDate = (d) => d.toISOString().split('T')[0];
                const url = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${formatDate(today)}&end_date=${formatDate(endDate)}&api_key=${NASA_API_KEY}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const asteroids = Object.values(data.near_earth_objects).flat();
                    dom.nasaDataList.innerHTML = '';
                    if (asteroids.length === 0) {
                        dom.nasaDataList.innerHTML = `<li>No asteroids found in the next 7 days.</li>`;
                        return;
                    }
                    asteroids.slice(0, 10).forEach(ast => {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-md cursor-pointer nasa-item';
                        li.textContent = `${ast.name}`;
                        li.dataset.diameter = Math.round((ast.estimated_diameter.meters.estimated_diameter_min + ast.estimated_diameter.meters.estimated_diameter_max) / 2);
                        li.dataset.velocity = Math.round(ast.close_approach_data[0].relative_velocity.kilometers_per_second);
                        li.setAttribute('aria-label', `Load asteroid ${ast.name}`);
                        li.setAttribute('tabindex', '0');
                        dom.nasaDataList.appendChild(li);
                    });
                } catch (error) {
                    console.error("Failed to fetch NASA data:", error);
                    dom.nasaDataList.innerHTML = `<li>Error loading data.</li>`;
                }
            }
            
            function showReportCard() {
                soundEngine.playClick();
                const outcome = appState.mitigation !== 'none' ? 'SUCCESS: THREAT AVERTED' : 'FAILURE: CATASTROPHIC IMPACT';
                const color = outcome.startsWith('SUCCESS') ? 'text-green-400' : 'text-red-400';
                dom.reportCardContent.innerHTML = `
                    <p class="text-xl font-bold ${color}">${outcome}</p>
                    <p><strong>Asteroid Size:</strong> ${appState.diameter} m</p>
                    <p><strong>Impact Velocity:</strong> ${appState.velocity} km/s</p>
                    <p><strong>Target:</strong> ${appState.location.charAt(0).toUpperCase() + appState.location.slice(1)}</p>
                    <p><strong>Mitigation Used:</strong> ${appState.mitigation.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p><strong>Resulting Energy:</strong> ${Number(calculateConsequences().energy).toLocaleString()} MT</p>
                `;
                dom.reportCardModal.classList.remove('hidden');
            }

            // --- Event Listeners ---
            dom.enableAudioBtn.addEventListener('click', () => {
                Tone.start();
                appState.isAudioEnabled = true;
                dom.audioModal.style.display = 'none';
                soundEngine.playSuccess();
            });
            dom.modeSandboxBtn.addEventListener('click', () => switchMode('sandbox'));
            dom.modeChallengeBtn.addEventListener('click', () => switchMode('challenge'));
            dom.sizeSlider.addEventListener('input', (e) => { appState.diameter = parseInt(e.target.value); updateUI(); });
            dom.velocitySlider.addEventListener('input', (e) => { appState.velocity = parseInt(e.target.value); updateUI(); });
            // MODIFIED: Event listener for mitigation dropdown
            dom.mitigationSelect.addEventListener('change', (e) => {
                appState.mitigation = e.target.value;
                soundEngine.playClick();
                if (appState.mitigation !== 'none') { soundEngine.playSuccess(); }
                updateUI();
                updateMitigationBriefing(); // Call the new function
            });
            dom.mapCanvas.addEventListener('click', (e) => {
                if (appState.mode === 'challenge') return;
                const rect = dom.mapCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                appState.location = getImpactLocation(x, y);
                soundEngine.playClick();
                updateUI();
            });
            dom.loadNasaDataBtn.addEventListener('click', fetchNasaData);
            dom.nasaDataList.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI' && e.target.dataset.diameter) {
                    appState.diameter = parseInt(e.target.dataset.diameter);
                    appState.velocity = parseInt(e.target.dataset.velocity);
                    soundEngine.playClick();
                    dom.nasaDataContainer.classList.add('hidden');
                    updateUI();
                }
            });
            dom.generateBriefingBtn.addEventListener('click', generateImpactBriefing);
            dom.closeModalBtn.addEventListener('click', () => dom.briefingModal.classList.add('hidden'));
            dom.shareReportCardBtn.addEventListener('click', showReportCard);
            dom.closeReportCardBtn.addEventListener('click', () => dom.reportCardModal.classList.add('hidden'));
            dom.copyReportCardBtn.addEventListener('click', () => {
                const text = dom.reportCardContent.innerText;
                dom.clipboardHelper.value = `â˜„ï¸ Meteor Madness Simulation Report â˜„ï¸\n\n${text}`;
                dom.clipboardHelper.select();
                document.execCommand('copy');
                soundEngine.playSuccess();
            });
            window.addEventListener('resize', () => {
                drawTrajectory();
                drawWorldMap();
            });
            
            // --- Initialization ---
            drawWorldMap();
            createChart();
            switchMode('sandbox');
        });
    </script>
</body>
</html>

